<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <link rel="alternate icon" type="image/png" href="/img/favicon.png">
    <title>南蓝的技术博客 | </title>
    
<link rel="stylesheet" href="/css/reset.css">

    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/css/markdown.css">

    
<link rel="stylesheet" href="/css/fonts.css">

<meta name="generator" content="Hexo 6.2.0"></head>
    <body>
        <div class="paper">
            <div class="paper-main">
                
                    <div class="post-header">
    <a class="logo" href="/">南蓝的技术博客</a>
    <a class="go-home" href="/">
        <svg width="8" height="14" viewBox="0 0 8 14">
            <path d="M7 1L1 7l6 6" stroke="#000" stroke-width="2" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </a>
</div>
                
                <div class="post-main">

    
        <div class="post-main-title">
            编译流程
        </div>
        <div class="post-meta">
            2022-06-04
        </div>
    

    <div class="post-md">
        <h2 id="编译流程"><a href="#编译流程" class="headerlink" title="编译流程"></a>编译流程</h2><h3 id="parse"><a href="#parse" class="headerlink" title="parse"></a>parse</h3><p>通过parse 转成AST语法树。 具体是把源代码转成转成机器能够理解的AST，这个过程分为<em>词法分析</em>、 <em>语法分析</em></p>
<h4 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h4><p>我们要源码把它分成一个个不能细分的单词（token）的过程称为<em>词法分析</em></p>
<h4 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h4><p>我们把token 进行递归的组装，生成AST的过程称为<em>词法分析</em></p>
<h5 id="AST"><a href="#AST" class="headerlink" title="AST"></a>AST</h5><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3dc91699e4ec4f69971b02b2c0c44651~tplv-k3u1fbpfcp-watermark.image" alt="AST.png"></p>
<h4 id="parse的API"><a href="#parse的API" class="headerlink" title="parse的API"></a>parse的API</h4><ul>
<li>@babel&#x2F;parser</li>
</ul>
<p>示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> parser = <span class="built_in">require</span>(<span class="string">&#x27;@babel/parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> ast = parser.<span class="title function_">parse</span>(sourceCode, &#123;</span><br><span class="line">    <span class="attr">sourceType</span>: <span class="string">&#x27;unambiguous&#x27;</span>, <span class="comment">// &quot;script&quot; | &quot;module&quot; | &quot;unambiguous&quot;</span></span><br><span class="line">    <span class="attr">plugins</span>: [<span class="string">&#x27;jsx&#x27;</span>]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li><p>sourceType的属性值<br><code>unambiguous</code> ：根据据内容是否有 import 和 export 来确定是否解析 es module 语法<br><code>module</code>： module 是解析 es module 语法<br><code>script</code>： 其他都是script</p>
</li>
<li><p>plugins</p>
</li>
</ul>
<p>如果要解析tsx 模块，那么可以这样来写</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;@babel/parser&quot;</span>).<span class="title function_">parse</span>(<span class="string">&quot;code&quot;</span>,</span><br><span class="line">&#123; <span class="attr">sourceType</span>: <span class="string">&quot;module&quot;</span>,</span><br><span class="line">    <span class="attr">plugins</span>: [ <span class="string">&quot;jsx&quot;</span>, <span class="string">&quot;typescript&quot;</span> ]</span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>parse 类型声明</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parse</span>(<span class="params"></span></span><br><span class="line"><span class="params">  input: string,</span></span><br><span class="line"><span class="params">  options?: ParserOptions</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">ParseResult</span>&lt;<span class="title function_">import</span>(<span class="string">&quot;@babel/types&quot;</span>).<span class="property">File</span>&gt;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://babeljs.io/docs/en/babel-parser#options">ParserOptions</a></p>
<h3 id="transform"><a href="#transform" class="headerlink" title="transform"></a>transform</h3><p>遍历AST，调用transform的各种API进行增删改查，遍历的过程中处理到不同的 AST 节点会调用注册的相应的 visitor 函数，visitor 函数里可以对 AST 节点进行增删改</p>
<h4 id="transform的API"><a href="#transform的API" class="headerlink" title="transform的API"></a>transform的API</h4><ul>
<li>@babel&#x2F;traverse: 遍历 AST</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">traverse</span>(ast, &#123;</span><br><span class="line">    <span class="title class_">CallExpression</span>:&#123;</span><br><span class="line">    <span class="title function_">enter</span>(<span class="params">path,state</span>)&#123;&#125;</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">traverse</span>(ast, &#123;</span><br><span class="line">    <span class="title class_">CallExpression</span>(path, state) &#123;</span><br><span class="line">       ...</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>上面两者等价</p>
<ul>
<li>@babel&#x2F;types： 遍历 AST 的过程中需要创建一些 AST 和判断 AST 的类型</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const types = require(&#x27;@babel/types&#x27;);</span><br><span class="line">traverse(ast, &#123;</span><br><span class="line">    CallExpression(path, state) &#123;</span><br><span class="line">        if ( types.isMemberExpression(path.node.callee)) &#123;</span><br><span class="line">          </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>@babel&#x2F;template: 简化 AST 创建逻辑</li>
</ul>
<p>可以遍历 AST，并调用 visitor 函数修改 AST，修改 AST 自然涉及到 AST 的判断、创建、修改等, 这时候就需要 <code>@babel/types</code> 了，当需要批量创建 AST 的时候可以使用 <code>@babel/template</code> 来简化 AST 创建逻辑</p>
<h3 id="generate"><a href="#generate" class="headerlink" title="generate"></a>generate</h3><p>把AST生成目标代码，并且转换成sourcemap</p>
<h4 id="generate的API"><a href="#generate的API" class="headerlink" title="generate的API"></a>generate的API</h4><ul>
<li>@babel&#x2F;generate: 把 AST 打印为目标代码字符串,同时生成 sourcemap</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> (<span class="params">ast: <span class="built_in">Object</span>, opts: GeneratorOptions, code: string</span>): &#123;code, map&#125;</span><br></pre></td></tr></table></figure>

<p>类型声明</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export default function generate(</span><br><span class="line">    ast: t.Node,</span><br><span class="line">    opts?: GeneratorOptions,</span><br><span class="line">    code?: string | &#123; [filename: string]: string &#125;,</span><br><span class="line">): GeneratorResult;</span><br></pre></td></tr></table></figure>

<p>options 中常用的是 sourceMaps，开启了这个选项才会生成 sourcemap</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; code, map &#125; = <span class="title function_">generate</span>(ast, &#123; <span class="attr">sourceMaps</span>: <span class="literal">true</span> &#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>@babel&#x2F;code-frame: 中途遇到错误想打印代码位置的时候</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="title function_">codeFrameColumns</span>(rawLines, location, &#123;</span><br><span class="line">  <span class="comment">/* options */</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="babel-x2F-core"><a href="#babel-x2F-core" class="headerlink" title="@babel&#x2F;core"></a>@babel&#x2F;core</h3><p>基于上面的包完成 babel 整体的编译流程</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; transformFileSync &#125; = <span class="built_in">require</span>(<span class="string">&#x27;@babel/core&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">transformSync</span>(code, options); <span class="comment">// =&gt; &#123; code, map, ast &#125; transformFileSync(filename, options); // =&gt; &#123; code, map, ast &#125; transformFromAstSync</span></span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p> babel 编译的三个阶段以及每个阶段对应的API</p>
<table>
<thead>
<tr>
<th>stage</th>
<th>名称</th>
<th>释义</th>
<th>相关的API</th>
<th>核心的点</th>
</tr>
</thead>
<tbody><tr>
<td>stage1</td>
<td>parse</td>
<td>转成AST语法树</td>
<td>@babel&#x2F;parser</td>
<td>词法分析（分词）、语法分析（组装AST）</td>
</tr>
<tr>
<td>stage2</td>
<td>transform</td>
<td>遍历AST，调用transform的各种API进行增删改查</td>
<td>@babel&#x2F;traverse 、@babel&#x2F;template、@babel&#x2F;types</td>
<td>path、scope、visitor</td>
</tr>
<tr>
<td>stage3</td>
<td>generate</td>
<td>生成sourcemap</td>
<td>@babel&#x2F;code-frame、@babel&#x2F;generate</td>
<td>generator、sourcemap</td>
</tr>
</tbody></table>
<p>整体能通过<code>@babel/core</code>完成编译的流程</p>
<p> 以上提到的api都是<code>tooling packages</code>,  这里再提一下 babel 还有<code>Integration Packages</code></p>
<h4 id="Integration-Packages"><a href="#Integration-Packages" class="headerlink" title="Integration Packages"></a>Integration Packages</h4><p> <a target="_blank" rel="noopener" href="https://babeljs.io/docs/en/babel-cli">@babel&#x2F;cli</a></p>
<p> <a target="_blank" rel="noopener" href="https://babeljs.io/docs/en/babel-polyfill">@babel&#x2F;polyfill</a></p>
<p><a target="_blank" rel="noopener" href="https://babeljs.io/docs/en/babel-plugin-transform-runtime">@babel&#x2F;plugin-transform-runtime</a></p>
<p><a target="_blank" rel="noopener" href="https://babeljs.io/docs/en/babel-register">@babel&#x2F;register</a></p>
<p><a target="_blank" rel="noopener" href="https://babeljs.io/docs/en/babel-standalone">@babel&#x2F;standalone</a></p>

    </div>

</div>
                

<link rel="stylesheet" href="/css/a11y-dark.min.css">


<script src="/js/highlight.min.js"></script>


<script src="/js/highlightjs-line-numbers.js"></script>


<script>
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
</script>

            </div>
        </div>
    </body>
</html>